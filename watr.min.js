const e=["unreachable","nop","block","loop","if","else",,,,,,"end","br","br_if","br_table","return","call","call_indirect",,,,,,,,,"drop","select",,,,,"local.get","local.set","local.tee","global.get","global.set",,,,"i32.load","i64.load","f32.load","f64.load","i32.load8_s","i32.load8_u","i32.load16_s","i32.load16_u","i64.load8_s","i64.load8_u","i64.load16_s","i64.load16_u","i64.load32_s","i64.load32_u","i32.store","i64.store","f32.store","f64.store","i32.store8","i32.store16","i64.store8","i64.store16","i64.store32","memory.size","memory.grow","i32.const","i64.const","f32.const","f64.const","i32.eqz","i32.eq","i32.ne","i32.lt_s","i32.lt_u","i32.gt_s","i32.gt_u","i32.le_s","i32.le_u","i32.ge_s","i32.ge_u","i64.eqz","i64.eq","i64.ne","i64.lt_s","i64.lt_u","i64.gt_s","i64.gt_u","i64.le_s","i64.le_u","i64.ge_s","i64.ge_u","f32.eq","f32.ne","f32.lt","f32.gt","f32.le","f32.ge","f64.eq","f64.ne","f64.lt","f64.gt","f64.le","f64.ge","i32.clz","i32.ctz","i32.popcnt","i32.add","i32.sub","i32.mul","i32.div_s","i32.div_u","i32.rem_s","i32.rem_u","i32.and","i32.or","i32.xor","i32.shl","i32.shr_s","i32.shr_u","i32.rotl","i32.rotr","i64.clz","i64.ctz","i64.popcnt","i64.add","i64.sub","i64.mul","i64.div_s","i64.div_u","i64.rem_s","i64.rem_u","i64.and","i64.or","i64.xor","i64.shl","i64.shr_s","i64.shr_u","i64.rotl","i64.rotr","f32.abs","f32.neg","f32.ceil","f32.floor","f32.trunc","f32.nearest","f32.sqrt","f32.add","f32.sub","f32.mul","f32.div","f32.min","f32.max","f32.copysign","f64.abs","f64.neg","f64.ceil","f64.floor","f64.trunc","f64.nearest","f64.sqrt","f64.add","f64.sub","f64.mul","f64.div","f64.min","f64.max","f64.copysign","i32.wrap_i64","i32.trunc_f32_s","i32.trunc_f32_u","i32.trunc_f64_s","i32.trunc_f64_u","i64.extend_i32_s","i64.extend_i32_u","i64.trunc_f32_s","i64.trunc_f32_u","i64.trunc_f64_s","i64.trunc_f64_u","f32.convert_i32_s","f32.convert_i32_u","f32.convert_i64_s","f32.convert_i64_u","f32.demote_f64","f64.convert_i32_s","f64.convert_i32_u","f64.convert_i64_s","f64.convert_i64_u","f64.promote_f32","i32.reinterpret_f32","i64.reinterpret_f64","f32.reinterpret_i32","f64.reinterpret_i64"],t={type:1,import:2,func:3,table:4,memory:5,global:6,export:7,start:8,elem:9,code:10,data:11},i={i32:127,i64:126,f32:125,f64:124,void:64,func:96,funcref:112},l={func:0,table:1,memory:2,global:3},s={"i32.load":4,"i64.load":8,"f32.load":4,"f64.load":8,"i32.load8_s":1,"i32.load8_u":1,"i32.load16_s":2,"i32.load16_u":2,"i64.load8_s":1,"i64.load8_u":1,"i64.load16_s":2,"i64.load16_u":2,"i64.load32_s":4,"i64.load32_u":4,"i32.store":4,"i64.store":8,"f32.store":4,"f64.store":8,"i32.store8":1,"i32.store16":2,"i64.store8":1,"i64.store16":2,"i64.store32":4};e.map(((t,i)=>e[t]=i));var f=e=>{let i={type:[],import:[],func:[],table:[],memory:[],global:[],export:[],start:[],elem:[],code:[],data:[]},l=[0,97,115,109,1,0,0,0];"string"==typeof e[0]&&"module"!==e[0]&&(e=[e]);for(let t in i){let l=[];for(let s of e)s[0]===t?o[t](s,i):l.push(s);e=l}for(let e in i){let s=i[e];if(s.importc&&(s=s.slice(s.importc)),!s.length)continue;let f=l.length+1;l.push(t[e],0),8!==l[f-1]&&l.push(s.length);for(let e of s)l.push(...e);l[f]=l.length-f-1}return new Uint8Array(l)};const o={type([,e,t],l){"$"!==e[0]&&(t=e,e=null);let s,f,o=[],r=[];if("func"===t.shift()){for(;"param"===t[0]?.[0];){let[,...e]=t.shift();"$"===e[0]?.[0]&&(o[e.shift()]=o.length),o.push(...e.map((e=>i[e])))}"result"===t[0]?.[0]&&(r=t.shift().slice(1).map((e=>i[e]))),f=[i.func,o.length,...o,r.length,...r],s=l.type.findIndex((e=>e.every(((e,t)=>e===f[t])))),s<0&&(s=l.type.push(f)-1)}return e&&(l.type[e]=s),[s,o,r]},func([,...t],l){let f=l.func.length,r=[];"$"===t[0]?.[0]&&(l.func[t.shift()]=f),"export"===t[0]?.[0]&&o.export([...t.shift(),["func",f]],l);let[n,u,_]=o.type([,["func",...t]],l);for(;"param"===t[0]?.[0]||"result"===t[0]?.[0];)t.shift();for(l.func.push([n]);"local"===t[0]?.[0];){let e,[,...l]=t.shift();"$"===l[0][0]&&(u[e=l.shift()]&&h("Ambiguous name "+e),r[e]=u.length+r.length),l.forEach((e=>r.push(i[e])))}const p=([t,...f])=>{1===t.length&&h(`Inline instructions are not supported \`${t+f.join("")}\``);let o=e[t],n=0,_=[],c=[];if(o>=40&&o<=62){let e,i={align:s[t],offset:0};for(;f[0]?.[0]in i;)e=f.shift(),i[e[0]]=+e[1];c=[Math.log2(i.align),Math.log2(i.offset)],n=o>=54?2:1}else if(o>=65&&o<=68)c=a(f.shift());else if(o>=32&&o<=34){let e=f.shift();c=a("$"===e[0]?u[e]||r[e]:e),o>32&&(n=1)}else if(35==o||36==o){let e=f.shift();c=a("$"===e[0]?l.global[e]:e),o>35&&(n=1)}else if(16==o){let e=f.shift();c=a(e="$"===e[0]?l.func[e]:e),[,n]=l.type[l.func[e][0]]}else if(17==o){let e=f.shift()[1];[,n]=l.type[e="$"===e[0]?l.type[e]:e],n++,c=[+e,0]}else if(63==o||64==o)c=[0],n=1;else if(o>=106)n=o>=167||o<=159&&o>=153||o<=145&&o>=139||o<=123&&o>=121||o<=105&&o>=103?1:2;else if(4==o){let t,[,l]="result"===f[0][0]?f.shift():[];n=0,_.push(...p(f.shift())),c=[i[l]],"then"===f[0][0]?[,...t]=f.shift():t=f,c.push(...t.flatMap(p)),"else"===f[0][0]&&([,...t]=f.shift(),c.push(e.else,...t.flatMap(p))),c.push(e.end)}else 26==o?n=1:h(`Unknown instruction \`${t}\``);for(f.length<n&&h(`Stack arguments are not supported at \`${t}\``);n--;)_.push(...p(f.shift()));return f.length&&h(`Too many arguments for \`${t}\`.`),[..._,o,...c]};let c=t.flatMap(p);l.code.push([c.length+2+2*r.length,r.length,...r.flatMap((e=>[1,e])),...c,e.end])},memory([,...e],t){if("$"===e[0][0]&&(t.memory[e.shift()]=t.memory.length),"import"===e[0][0]){let[i,...l]=e;return o.import([...i,["memory",...l]],t)}t.memory.push(u(e))},global([,...e],t){let l="$"===e[0][0]&&e.shift();l&&(t.global[l]=t.global.length);let[s,f]=e,o="mut"===s[0];t.global.push([i[o?s[1]:s],o,...r(f)])},table([,...e],t){let l="$"===e[0][0]&&e.shift();l&&(t.table[l]=t.table.length);let s=u(e);t.table.push([i[e.pop()],...s])},elem([,e,...t],i){i.elem.push([0,...r(e,i),t.length,...t.map((e=>"$"===e[0]?i.func[e]:+e))])},export([,e,[t,i]],s){"$"===i[0]&&(i=s[t][i]),s.export.push([...n(e),l[t],+i])},import([,e,t,i],s){let f,[r,...a]=i;if("func"===r){"$"===a[0]?.[0]&&(s.func[a.shift()]=s.func.length);let[e]=o.type([,["func",...a]],s);s.func.push(f=[e]),s.func.importc=(s.func.importc||0)+1}else"memory"===r&&("$"===a[0][0]&&(s.memory[a.shift()]=s.memory.length),f=u(a));s.import.push([...n(e),...n(t),l[r],...f])},data([,e,t],i){i.data.push([0,...r(e,i),...n(t)])},start([,e],t){t.start.length||t.start.push(["$"===e[0]?t.func[e]:e])}},r=([t,i],l)=>[e[t],...a("$"===i[0]?l.global[i]:i),e.end],n=e=>{e='"'===e[0]?e.slice(1,-1):e;let t,i=[0],l=0;for(;l<e.length;)t=e.charCodeAt(l++),i.push(92===t?parseInt(e.slice(l,l+=2),16):t);return i[0]=i.length-1,i},u=([e,t,i])=>isNaN(parseInt(t))?[0,+e]:["shared"===i?3:1,+e,+t],a=e=>{e|=0;const t=[];for(;;){const i=127&e;if(0==(e>>=7)&&0==(64&i)||-1===e&&0!=(64&i))return t.push(i),t;t.push(128|i)}},h=e=>{throw Error(e)};var _=e=>{let t=0,i=[],l="";const s=()=>l&&(i.push(~l.indexOf("=")?l.split("="):l),l=""),f=()=>{for(let o,r;t<e.length;)if(o=e.charCodeAt(t),40===o)59===e.charCodeAt(t+1)?t=e.indexOf(";)",t)+2:(t++,(r=i).push(i=[]),f(),i=r);else if(59===o)t=e.indexOf("\n",t)+1;else if(o<=32)s(),t++;else{if(41===o)return s(),t++;l+=e[t++]}s()};return f(),i.length>1?i:i[0]},p=e=>(e="string"==typeof e?_(e):e,f(e));export{f as compile,p as default,_ as parse};